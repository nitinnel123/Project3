<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Global Development Dashboard (1960‚Äì2020)</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f8f9fa;
      margin: 20px;
    }
    svg {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 6px rgba(0,0,0,0.15);
    }
    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.75);
      color: white;
      padding: 8px 10px;
      border-radius: 5px;
      pointer-events: none;
      font-size: 13px;
      line-height: 1.4em;
    }
    .controls { margin: 15px 0; }
    .year-label { font-weight: bold; margin-left: 10px; font-size: 16px; }
    h2 { margin-bottom: 0; }

    #diagnostics {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 12px;
      margin-top: 18px;
      max-height: 250px;
      overflow-y: auto;
      font-size: 13px;
    }
    #diagnostics h3 { margin-top: 0; font-size: 14px; color: #333; }
    .unmatched { color: #b91c1c; margin-bottom: 6px; }
    .missing-data { color: #92400e; margin-top: 10px; }

    #popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 10;
    }
    #popup.hidden { display: none; }
    #popup-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      position: relative;
    }
    #close-btn {
      position: absolute;
      top: 5px; right: 10px;
      border: none;
      background: none;
      font-size: 22px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>üåç Global Development Dashboard (1960‚Äì2020)</h2>
  <p>Explore how income, education, and health outcomes evolve across countries and over time.</p>

  <div class="controls">
    <label>Metric:
      <select id="metric">
        <option value="gdp">GDP per Capita (Income)</option>
        <option value="education">Secondary Enrollment (% Gross)</option>
        <option value="life">Life Expectancy (Years)</option>
      </select>
    </label>
    <label class="year-label" id="year-label">1960</label>
    <input type="range" id="year" min="1960" max="2020" value="1960" step="1" />
  </div>

  <svg width="960" height="550"></svg>
  <div class="tooltip"></div>

  <div id="diagnostics">
    <h3>Data Diagnostics</h3>
    <div id="unmatched-countries" class="unmatched"></div>
    <div id="missing-countries" class="missing-data"></div>
  </div>

  <div id="popup" class="hidden">
    <div id="popup-content">
      <button id="close-btn">&times;</button>
      <h3 id="popup-title"></h3>
      <svg id="popup-chart" width="600" height="350"></svg>
    </div>
  </div>

  <script>
    const width = 960, height = 550;
    const svg = d3.select("svg");
    const tooltip = d3.select(".tooltip");
    const projection = d3.geoNaturalEarth1().scale(160).translate([width/2, height/2]);
    const path = d3.geoPath(projection);

    let year = 1960;
    let metric = "gdp";

    const nameMap = {
      "USA": "United States of America",
      "United States": "United States of America",
      "England": "United Kingdom of Great Britain and Northern Ireland",
      "Russia": "Russian Federation",
      "Iran": "Iran (Islamic Republic of)",
      "Iran, Islamic Rep.": "Iran (Islamic Republic of)",
      "Yemen": "Yemen, Rep.",
      "Yemen, Rep.": "Yemen, Rep.",
      "Syria": "Syrian Arab Republic",
      "South Korea": "Republic of Korea",
      "Korea, Rep.": "Republic of Korea",
      "North Korea": "Democratic People's Republic of Korea",
      "Korea, Dem. People's Rep.": "Democratic People's Republic of Korea",
      "Vietnam": "Viet Nam",
      "Viet Nam": "Viet Nam",
      "Laos": "Lao People's Democratic Republic",
      "Lao PDR": "Lao People's Democratic Republic",
      "Czech Republic": "Czechia",
      "Ivory Coast": "C√¥te d'Ivoire",
      "Cote d'Ivoire": "C√¥te d'Ivoire",
      "Republic of Serbia": "Serbia",
      "Macedonia": "North Macedonia",
      "North Macedonia": "North Macedonia",
      "Bolivia": "Bolivia (Plurinational State of)",
      "Venezuela": "Venezuela (Bolivarian Republic of)",
      "Venezuela, RB": "Venezuela (Bolivarian Republic of)",
      "Brunei": "Brunei Darussalam",
      "Gambia": "Gambia, The",
      "Guinea Bissau": "Guinea-Bissau",
      "Republic of the Congo": "Congo",
      "Congo, Rep.": "Congo",
      "Egypt": "Egypt, Arab Republic of",
      "Egypt, Arab Rep.": "Egypt, Arab Republic of",
      "Taiwan": "Taiwan, Province of China",
      "East Timor": "Timor-Leste",
      "Somaliland": "Somalia",
      "West Bank": "Palestine, State of",
      "Falkland Islands": "Falkland Islands (Malvinas)",
      "Bahamas": "Bahamas, The",
      "The Bahamas": "Bahamas, The",
      "Western Sahara": "Western Sahara",
      "Northern Cyprus": "Cyprus",
      "Antarctica": null,
      "French Southern and Antarctic Lands": null,
      "Taiwan, Province of China": "Taiwan, Province of China"
    };

    const regionNames = [
      "Arab World", "Caribbean small states", "Euro area", "European Union",
      "Heavily indebted poor countries (HIPC)", "Middle East & North Africa",
      "Sub-Saharan Africa", "IDA total", "IBRD only", "IDA only",
      "Latin America & Caribbean", "Middle income", "High income",
      "Low income", "Upper middle income", "Lower middle income",
      "World", "Small states", "East Asia & Pacific", "South Asia",
      "OECD members", "Pre-demographic dividend", "Post-demographic dividend",
      "IDA blend", "Late-demographic dividend", "Early-demographic dividend",
      "Fragile and conflict affected situations"
    ];

    const normalize = name => {
      if (regionNames.includes(name)) return null;
      const mapped = nameMap[name];
      if (mapped === null) return null;
      return mapped || name;
    };

    Promise.all([
      d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson"),
      d3.csv("economy-and-growth.csv"),
      d3.csv("education.csv"),
      d3.csv("social-development.csv")
    ]).then(([world, econ, edu, social]) => {

      const dataMap = {};
      const safe = v => +v || null;

      econ.forEach(d => {
        const norm = normalize(d["Country Name"]);
        if (!norm) return;
        const key = `${norm}-${d.Year}`;
        if (!dataMap[key]) dataMap[key] = { Country: norm, Year: +d.Year };
        dataMap[key].gdp = safe(d["average_value_GDP per capita (current US$)"]);
      });

      edu.forEach(d => {
        const norm = normalize(d["Country Name"]);
        if (!norm) return;
        const key = `${norm}-${d.Year}`;
        if (!dataMap[key]) dataMap[key] = { Country: norm, Year: +d.Year };
        dataMap[key].education = safe(d["average_value_School enrollment, secondary (% gross)"]);
      });

      social.forEach(d => {
        const norm = normalize(d["Country Name"]);
        if (!norm) return;
        const key = `${norm}-${d.Year}`;
        if (!dataMap[key]) dataMap[key] = { Country: norm, Year: +d.Year };
        const male = safe(d["average_value_Life expectancy at birth, male (years)"]);
        const female = safe(d["average_value_Life expectancy at birth, female (years)"]);
        if (male && female) dataMap[key].life = (male + female) / 2;
      });

      const data = Object.values(dataMap);

      const csvCountries = new Set(data.map(d => d.Country));
      const geoCountries = new Set(world.features.map(f => f.properties.name));
      const unmatchedInGeo = [...csvCountries].filter(c => !geoCountries.has(c));
      const unmatchedInCSV = [...geoCountries].filter(c => !csvCountries.has(c));
      d3.select("#unmatched-countries").html(`
        <strong>üåê CSV countries not found in GeoJSON:</strong><br>
        ${unmatchedInGeo.length ? unmatchedInGeo.join(", ") : "‚úÖ All matched!"}
      `);
      console.log("Unmatched in GeoJSON:", unmatchedInGeo);

      const countries = svg.append("g")
        .selectAll("path")
        .data(world.features)
        .join("path")
        .attr("d", path)
        .attr("fill", "#e0e0e0")
        .attr("stroke", "#999");

      const color = d3.scaleSequential(d3.interpolateYlGnBu);

      function update() {
        const yearData = data.filter(d => d.Year === year);
        const byCountry = {};
        yearData.forEach(d => { byCountry[d.Country] = d[metric]; });
        const values = Object.values(byCountry).filter(v => v != null);
        color.domain([d3.min(values), d3.max(values)]);
        countries.transition().duration(400)
          .attr("fill", d => {
            const val = byCountry[d.properties.name];
            return val ? color(val) : "#ccc";
          });

        const missing = world.features
          .map(f => f.properties.name)
          .filter(n => !byCountry[n]);
        d3.select("#missing-countries").html(`
          <strong>üö´ Countries with no data for ${year}:</strong><br>
          ${missing.slice(0, 20).join(", ")}${missing.length > 20 ? ", ..." : ""}
        `);
        d3.select("#year-label").text(year);
      }

      countries.on("mousemove", (event, d) => {
        const name = d.properties.name;
        const val = data.find(x => x.Country === name && x.Year === year);
        tooltip.style("left", (event.pageX + 12) + "px")
          .style("top", (event.pageY - 28) + "px")
          .style("opacity", 1)
          .html(`
            <strong>${name}</strong><br>
            GDP per Capita: ${val?.gdp ? "$" + Math.round(val.gdp).toLocaleString() : "N/A"}<br>
            Secondary Enrollment: ${val?.education ? val.education.toFixed(1) + "%" : "N/A"}<br>
            Life Expectancy: ${val?.life ? val.life.toFixed(1) + " years" : "N/A"}
          `);
      }).on("mouseout", () => tooltip.style("opacity", 0));

      d3.select("#metric").on("change", e => { metric = e.target.value; update(); });
      d3.select("#year").on("input", e => { year = +e.target.value; update(); });


      const popup = d3.select("#popup");
      const popupTitle = d3.select("#popup-title");
      const popupChart = d3.select("#popup-chart");
      d3.select("#close-btn").on("click", () => popup.classed("hidden", true));

      countries.on("click", (event, d) => {
        const countryName = d.properties.name;
        const countryData = data.filter(x => x.Country === countryName);
        if (!countryData.length) {
          alert(`No data available for ${countryName}`);
          return;
        }
        popup.classed("hidden", false);
        popupTitle.text(countryName);

        const years = [...new Set(countryData.map(d => d.Year))].sort((a,b)=>a-b);
        const gdp = years.map(y => ({year: y, value: countryData.find(d=>d.Year===y)?.gdp || null}));
        const edu = years.map(y => ({year: y, value: countryData.find(d=>d.Year===y)?.education || null}));
        const life = years.map(y => ({year: y, value: countryData.find(d=>d.Year===y)?.life || null}));

        const allValues = [...gdp, ...edu, ...life].map(d => d.value).filter(v => v != null);
        const yMin = d3.min(allValues);
        const yMax = d3.max(allValues);

        popupChart.selectAll("*").remove();
        const margin = {top: 40, right: 30, bottom: 40, left: 60};
        const width = 600 - margin.left - margin.right;
        const height = 350 - margin.top - margin.bottom;
        const svgLine = popupChart.append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleLinear().domain(d3.extent(years)).range([0, width]);
        const y = d3.scaleLinear().domain([yMin, yMax]).nice().range([height, 0]);
        svgLine.append("g").attr("transform", `translate(0,${height})`)
          .call(d3.axisBottom(x).tickFormat(d3.format("d")));
        svgLine.append("g").call(d3.axisLeft(y));

        const lineGen = d3.line().x(d => x(d.year)).y(d => y(d.value));
        svgLine.append("path").datum(gdp).attr("fill","none").attr("stroke","#2563eb").attr("stroke-width",2).attr("d", lineGen);
        svgLine.append("path").datum(edu).attr("fill","none").attr("stroke","#16a34a").attr("stroke-width",2).attr("d", lineGen);
        svgLine.append("path").datum(life).attr("fill","none").attr("stroke","#dc2626").attr("stroke-width",2).attr("d", lineGen);

        const legend = svgLine.selectAll(".legend")
          .data(["GDP per Capita ($)", "Secondary Enrollment (%)", "Life Expectancy (yrs)"])
          .enter().append("g")
          .attr("transform", (d,i)=>`translate(0,${-25 - i*15})`);
        const colors = ["#2563eb", "#16a34a", "#dc2626"];
        legend.append("rect").attr("x", 0).attr("width", 12).attr("height", 12)
          .attr("fill", (d,i)=>colors[i]);
        legend.append("text").attr("x", 18).attr("y", 10).text(d=>d).style("font-size","12px");
      });

      update();
    });
  </script>
</body>
</html>
