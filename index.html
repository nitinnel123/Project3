<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Global Development Dashboard (1960‚Äì2020)</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f8f9fa;
      margin: 20px;
    }
    svg {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 6px rgba(0,0,0,0.15);
    }
    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.75);
      color: white;
      padding: 8px 10px;
      border-radius: 5px;
      pointer-events: none;
      font-size: 13px;
      line-height: 1.4em;
    }
    .controls { margin: 15px 0; }
    .year-label { font-weight: bold; margin-left: 10px; font-size: 16px; }
    h2 { margin-bottom: 0; }

    #popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 10;
    }
    #popup.hidden { display: none; }
    #popup-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      position: relative;
    }
    #close-btn {
      position: absolute;
      top: 5px; right: 10px;
      border: none;
      background: none;
      font-size: 22px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>üåç Global Development Dashboard (1960‚Äì2020)</h2>
  <p>Explore how income, education, and health outcomes evolve across countries and over time.</p>

  <div class="controls">
    <label>Metric:
      <select id="metric">
        <option value="gdp">GDP per Capita (Income)</option>
        <option value="education">Secondary Enrollment (% Gross)</option>
        <option value="life">Life Expectancy (Years)</option>
      </select>
    </label>
    <label class="year-label" id="year-label">1960</label>
    <input type="range" id="year" min="1960" max="2020" value="1960" step="1" />
  </div>

  <svg width="960" height="550"></svg>
  <div class="tooltip"></div>

  <div id="popup" class="hidden">
    <div id="popup-content">
      <button id="close-btn">&times;</button>
      <h3 id="popup-title"></h3>
      <svg id="popup-chart" width="600" height="350"></svg>
    </div>
  </div>

  <script>
    const width = 960, height = 550;
    const svg = d3.select("svg");
    const tooltip = d3.select(".tooltip");
    const projection = d3.geoNaturalEarth1().scale(160).translate([width / 2, height / 2]);
    const path = d3.geoPath(projection);
    let year = 1960, metric = "gdp";

      const nameMap = {
      "USA": "United States of America",
      "United States": "United States of America",
      "U.S.A.": "United States of America",
      "Bahamas, The": "Bahamas",
      "Brunei Darussalam": "Brunei",
      "Cabo Verde": "Cape Verde",
      "Congo, Dem. Rep.": "Democratic Republic of the Congo",
      "Congo, Rep.": "Republic of the Congo",
      "Cote d'Ivoire": "Ivory Coast",
      "Egypt, Arab Rep.": "Egypt",
      "Eswatini": "Swaziland",
      "Gambia, The": "Gambia",
      "Guinea-Bissau": "Guinea Bissau",
      "Iran, Islamic Rep.": "Iran",
      "Korea, Dem. People‚Äôs Rep.": "North Korea",
      "Korea, Rep.": "South Korea",
      "Lao PDR": "Laos",
      "Macedonia": "North Macedonia",
      "North Macedonia": "North Macedonia",
      "Russian Federation": "Russia",
      "Syrian Arab Republic": "Syria",
      "Venezuela, RB": "Venezuela",
      "Viet Nam": "Vietnam",
      "Yemen, Rep.": "Yemen",
      "Bolivia (Plurinational State of)": "Bolivia",
      "Iran (Islamic Republic of)": "Iran",
      "Tanzania, United Republic of": "Tanzania",
      "Micronesia, Fed. Sts.": "Micronesia",
      "St. Kitts and Nevis": "Saint Kitts and Nevis",
      "St. Lucia": "Saint Lucia",
      "St. Vincent and the Grenadines": "Saint Vincent and the Grenadines",
      "Antigua and Barbuda": "Antigua and Barbuda",
      "Czech Republic": "Czechia",
      "Timor-Leste": "East Timor",
      "S√£o Tom√© and Pr√≠ncipe": "Sao Tome and Principe",
      "Slovak Republic": "Slovakia",
      "Hong Kong SAR, China": "Hong Kong",
      "Macao SAR, China": "Macao",
      "Palestine, State of": "Palestine",
      "Kyrgyz Republic": "Kyrgyzstan"
    };


    const regionNames = [
      "Arab World", "Caribbean small states", "Euro area", "European Union",
      "Heavily indebted poor countries (HIPC)", "Middle East & North Africa",
      "Sub-Saharan Africa", "IDA total", "IBRD only", "IDA only",
      "Latin America & Caribbean", "Middle income", "High income",
      "Low income", "Upper middle income", "Lower middle income",
      "World", "Small states", "East Asia & Pacific", "South Asia",
      "OECD members", "Pre-demographic dividend", "Post-demographic dividend",
      "IDA blend", "Late-demographic dividend", "Early-demographic dividend",
      "Fragile and conflict affected situations"
    ];

    const normalize = name => {
      if (regionNames.includes(name)) return null;
      const mapped = nameMap[name];
      if (mapped === null) return null;
      return mapped || name;
    };

    Promise.all([
      d3.json("world.geojson"),
      d3.csv("economy-and-growth.csv"),
      d3.csv("education.csv"),
      d3.csv("social-development.csv")
    ]).then(([world, econ, edu, social]) => {
      const dataMap = {};
      const safe = v => +v || null;

      econ.forEach(d => {
        const norm = normalize(d["Country Name"]);
        if (!norm) return;
        const key = `${norm}-${d.Year}`;
        if (!dataMap[key]) dataMap[key] = { Country: norm, Year: +d.Year };
        dataMap[key].gdp = safe(d["average_value_GDP per capita (current US$)"]);
      });

      edu.forEach(d => {
        const norm = normalize(d["Country Name"]);
        if (!norm) return;
        const key = `${norm}-${d.Year}`;
        if (!dataMap[key]) dataMap[key] = { Country: norm, Year: +d.Year };
        dataMap[key].education = safe(d["average_value_School enrollment, secondary (% gross)"]);
      });

      social.forEach(d => {
        const norm = normalize(d["Country Name"]);
        if (!norm) return;
        const key = `${norm}-${d.Year}`;
        if (!dataMap[key]) dataMap[key] = { Country: norm, Year: +d.Year };
        const male = safe(d["average_value_Life expectancy at birth, male (years)"]);
        const female = safe(d["average_value_Life expectancy at birth, female (years)"]);
        if (male && female) dataMap[key].life = (male + female) / 2;
      });

      const data = Object.values(dataMap);
      const countries = svg.append("g")
        .selectAll("path")
        .data(world.features)
        .join("path")
        .attr("d", path)
        .attr("fill", "#e0e0e0")
        .attr("stroke", "#999");

      const color = d3.scaleSequential(d3.interpolateYlGnBu);

      const legendWidth = 250, legendHeight = 12;
      const legendSvg = svg.append("g")
        .attr("class", "legend")
        .attr("transform", `translate(${width - legendWidth - 80}, ${height - 100})`);
      const defs = svg.append("defs");
      const linearGradient = defs.append("linearGradient").attr("id", "legend-gradient");
      linearGradient.selectAll("stop")
        .data([{offset:"0%",color:d3.interpolateYlGnBu(0)},{offset:"100%",color:d3.interpolateYlGnBu(1)}])
        .enter().append("stop")
        .attr("offset", d=>d.offset).attr("stop-color", d=>d.color);
      legendSvg.append("rect")
        .attr("width", legendWidth)
        .attr("height", legendHeight)
        .style("fill", "url(#legend-gradient)")
        .attr("stroke", "#999");
      const legendScale = d3.scaleLinear().range([0, legendWidth]);
      const legendAxis = legendSvg.append("g").attr("transform", `translate(0, ${legendHeight})`);

      function updateLegend(min,max,label){
        legendScale.domain([min,max]);
        const axis=d3.axisBottom(legendScale).tickValues([min,(min+max)/2,max]).tickFormat(d3.format(".2s"));
        legendAxis.call(axis);
        svg.selectAll(".legend-label").remove();
        svg.append("text")
          .attr("class","legend-label")
          .attr("x",width - legendWidth - 80)
          .attr("y",height - 110)
          .text(label)
          .style("font-size","13px")
          .style("font-weight","600");
      }


      function update(){
        const yearData=data.filter(d=>d.Year===year);
        const byCountry={};
        yearData.forEach(d=>{byCountry[d.Country]=d[metric];});
        const values=Object.values(byCountry).filter(v=>v!=null);
        color.domain([d3.min(values),d3.max(values)]);
        countries.transition().duration(400)
          .attr("fill",d=>{
            const val=byCountry[d.properties.name];
            return val?color(val):"#ccc";
          });
        const label=metric==="gdp"?"GDP per Capita (US$)":metric==="education"?"Secondary Enrollment (%)":"Life Expectancy (Years)";
        updateLegend(d3.min(values),d3.max(values),label);
      }

      countries.on("mousemove",(event,d)=>{
        const name=d.properties.name;
        const val=data.find(x=>x.Country===name&&x.Year===year);
        tooltip.style("left",(event.pageX+12)+"px")
          .style("top",(event.pageY-28)+"px")
          .style("opacity",1)
          .html(`<strong>${name}</strong><br>
                 GDP: ${val?.gdp?"$"+Math.round(val.gdp).toLocaleString():"N/A"}<br>
                 Life Expectancy: ${val?.life?val.life.toFixed(1)+" years":"N/A"}`);
      }).on("mouseout",()=>tooltip.style("opacity",0));

      d3.select("#metric").on("change",e=>{metric=e.target.value;update();});
      d3.select("#year").on("input",e=>{year=+e.target.value;d3.select("#year-label").text(year);update();});

      const popup=d3.select("#popup"),popupTitle=d3.select("#popup-title"),popupChart=d3.select("#popup-chart");
      d3.select("#close-btn").on("click",()=>popup.classed("hidden",true));

      countries.on("click",(event,d)=>{
        const countryName=d.properties.name;
        const countryData=data.filter(x=>x.Country===countryName);
        if(!countryData.length){alert(`No data for ${countryName}`);return;}
        popup.classed("hidden",false);
        popupTitle.text(`${countryName} ‚Äî GDP vs Life Expectancy`);
        const years=[...new Set(countryData.map(d=>d.Year))].sort((a,b)=>a-b);
        const gdp=years.map(y=>({year:y,value:countryData.find(d=>d.Year===y)?.gdp||null}));
        const life=years.map(y=>({year:y,value:countryData.find(d=>d.Year===y)?.life||null}));
        popupChart.selectAll("*").remove();
        const margin={top:40,right:60,bottom:40,left:70};
        const w=600-margin.left-margin.right,h=350-margin.top-margin.bottom;
        const svgLine=popupChart.append("g").attr("transform",`translate(${margin.left},${margin.top})`);
        const x=d3.scaleLinear().domain(d3.extent(years)).range([0,w]);
        const yLeft=d3.scaleLinear().domain([0,d3.max(gdp,d=>d.value)*1.1]).range([h,0]);
        const yRight=d3.scaleLinear().domain([d3.min(life,d=>d.value)-5,d3.max(life,d=>d.value)+5]).range([h,0]);
        svgLine.append("g").attr("transform",`translate(0,${h})`).call(d3.axisBottom(x).tickFormat(d3.format("d")));
        svgLine.append("g").call(d3.axisLeft(yLeft).ticks(6));
        svgLine.append("g").attr("transform",`translate(${w},0)`).call(d3.axisRight(yRight).ticks(6));
        const gdpLine=d3.line().x(d=>x(d.year)).y(d=>yLeft(d.value));
        const lifeLine=d3.line().x(d=>x(d.year)).y(d=>yRight(d.value));
        svgLine.append("path").datum(gdp).attr("fill","none").attr("stroke","#2563eb").attr("stroke-width",2).attr("d",gdpLine);
        svgLine.append("path").datum(life).attr("fill","none").attr("stroke","#dc2626").attr("stroke-width",2).attr("d",lifeLine);
        const legend=svgLine.selectAll(".legend")
          .data([{label:"GDP per Capita ($)",color:"#2563eb"},{label:"Life Expectancy (years)",color:"#dc2626"}])
          .enter().append("g").attr("transform",(d,i)=>`translate(0,${-25-i*15})`);
        legend.append("rect").attr("x",0).attr("width",12).attr("height",12).attr("fill",d=>d.color);
        legend.append("text").attr("x",18).attr("y",10).text(d=>d.label).style("font-size","12px");
      });

      update();
    });
  </script>
</body>
</html>
